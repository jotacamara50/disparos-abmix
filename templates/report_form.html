{% extends "base.html" %}

{% block content %}
<div class="form-card">
  <div class="form-header">
    <h1>{{ 'Editar lancamento' if report else 'Novo lancamento' }}</h1>
    <p>Preencha os dados diarios e distribua os aceites por vendedor.</p>
  </div>
  <form method="post" class="mt-3">
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="form-label">Data</label>
        <input class="form-control" type="date" name="report_date" id="report_date" value="{{ report.report_date.isoformat() if report else '' }}" required>
      </div>
      <div class="col-6 col-md-4">
        <label class="form-label">Disparos</label>
        <input class="form-control" type="number" min="0" name="total_sent" value="{{ report.total_sent if report else '' }}" required>
      </div>
      <div class="col-6 col-md-4">
        <label class="form-label">Aceites</label>
        <input class="form-control" type="number" min="0" name="total_accepted" id="total_accepted" value="{{ report.total_accepted if report else '' }}" required>
      </div>
    </div>

    <div class="mt-4">
      <h2 class="section-title">Encaminhamento por vendedor</h2>
      <div class="row g-3 mt-1">
        {% for vendor in vendors %}
          <div class="col-12 col-md-6">
            <div class="vendor-input">
              <div>
                <div class="vendor-name">{{ vendor.name }}</div>
                <div class="vendor-email">{{ vendor.email }}</div>
              </div>
              <input class="form-control vendor-count" type="number" min="0" name="vendor_{{ vendor.id }}" value="{{ allocations_map[vendor.id] if allocations_map and vendor.id in allocations_map else '' }}" placeholder="0">
            </div>
          </div>
        {% else %}
          <div class="col-12 text-muted">Nenhum vendedor ativo cadastrado.</div>
        {% endfor %}
      </div>
    </div>

    <div class="mt-4">
      <label class="form-label">Observacoes</label>
      <textarea class="form-control" name="notes" rows="3">{{ report.notes if report else '' }}</textarea>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-4">
      <button class="btn btn-primary" type="submit">Salvar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  const inputs = document.querySelectorAll('.vendor-count');
  const totalAccepted = document.getElementById('total_accepted');

  function recalc() {
    let sum = 0;
    inputs.forEach(input => {
      const value = parseInt(input.value || '0', 10);
      if (!isNaN(value)) {
        sum += value;
      }
    });
    totalAccepted.dataset.sum = sum;
  }

  inputs.forEach(input => input.addEventListener('input', recalc));
  recalc();

  const dateInput = document.getElementById('report_date');
  if (dateInput && !dateInput.value) {
    const today = new Date().toISOString().slice(0, 10);
    dateInput.value = today;
  }
</script>
{% endblock %}
